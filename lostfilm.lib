#Функции для работы с лостфильмом

if [ ! "$L_LOSTFILM_LIB" == "LOADED" ]; then
L_LOSTFILM_LIB="LOADED"

lostfilm_check(){
	log_it "Начало проверки Lostfilm.TV"
	mkdir -p "$TEMPORARY_DIR"
	id=0
	for gname in ${gname_lines[@]}; do
		name=${name_lines[$id]}
		gname=${gname_lines[$id]}
		url=${url_lines[$id]}
		path=${path_lines[$id]}
		torrents_list="$TEMPORARY_DIR/${name}.torrents-list"
		
		log_inprogress "Проверка $gname"
		log_stages 1 "Загрузка списка торрент-файлов"
		wget -q -O- $url | grep -o "/download.php/.*${name}.*\.torrent" \
				| grep -ir "S[0-9]\{1,\}E[0-9]\{1,\}" | sed -r "s/\/download.php\/(.*${name}.*\.torrent)/\1/g" \
				| sort -u > $torrents_list
		log_stages 1 "Обнаружение новых серий по базе данных"
		while read current; do
			torrent_exists $current
			if [ $? -eq 0 ]; then
				log_it "Новая серия: $current"
				cd $TORRENTS_DIR
				[ $FAKE -eq 0 ] && wget "http://www.lostfilm.tv/download.php/$current" --header \
					"Cookie: uid=$LOSTFILM_USERID; pass=$LOSTFILM_PASSWD" -N >/dev/null 2>&1 \
					&& add_to_base "$name" "$current"
				[ $FAKE -eq 0 ] || add_to_base "$name" "$current"
			fi
		done < $torrents_list
		rm -f $torrents_list
		log_inprogress_ok "Проверка $gname"
		id=$(($id+1))
	done
}

fi
